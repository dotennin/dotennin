---
title: 百度云文件直接下载思考
date: 2020-07-03 22:39:40
tags:
  - JavaScript
---

&nbsp;对于超过一定大小的文件百度云需要下载其客户端工具才能下载。&nbsp;<div><div>虽然我们能够获得下载的链接，但是因为百度云在验证模块加入了头部验证导致一般浏览器无法使用内置的下载器下载文件。 虽然这一步骤用第三方下载器可以下载，但操作步骤比较繁琐。</div><div>&nbsp; 为了解决这个问题， 所以想出了在浏览器的缓存块中下载文件， 并将下载完后的 blob 数据重新打包的想法。</div><div><font size="4"><br /></font></div><div><b><font size="4">问题：&nbsp;</font></b></div><div><ol style="text-align: left;"><li>无法下载大文件， 通常大于 500MB 大小的文件</li><ul><li>XHR API 改成 fetch API</li></ul><li>下载大文件调用 blob 处理时， 非常耗时</li><ul><li>XHR API 改成 fetch API 后 改成流处理<a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API" rel="nofollow noopener" style="background-color: white; box-sizing: inherit; color: #6200ac; font-size: 16px; text-decoration-line: none; word-break: break-all;" target="_blank">Streams</a>&nbsp;API</li></ul><li>使用 fetch 之后 User-agent 不能自定义</li><ul><li>使用插件更改(user-agent-switcher)， 或者开发专用插件（计划中）</li></ul></ol><div>-------------------------------------</div></div><div>以上问题用 GM_download 完美解决 Orz</div><div><br /></div><div><br /></div><div><p style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 17px; margin: 0px; padding: 0px; text-align: justify;">&nbsp;2、后台处理接口实现下载进度条</p><div class="cnblogs_code" style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 18px; margin: 0px; padding: 0px; text-align: justify;"><pre style="-webkit-tap-highlight-color: transparent; background-color: whitesmoke; border-radius: 4px; border: 1px solid rgb(204, 204, 204); color: #616161; font-family: monospace, monospace; font-size: 1em; line-height: 1.42857; margin-bottom: 10px; margin-top: 0px; overflow-wrap: break-word; overflow: auto; padding: 9.5px; word-break: break-all;"><span style="-webkit-tap-highlight-color: transparent; color: blue; margin: 0px; padding: 0px;">public</span> <span style="-webkit-tap-highlight-color: transparent; color: blue; margin: 0px; padding: 0px;">void</span><span style="-webkit-tap-highlight-color: transparent; color: black; margin: 0px; padding: 0px;"> aaa()
{  
 string result </span>=<span style="-webkit-tap-highlight-color: transparent; color: black; margin: 0px; padding: 0px;"> string.Empty;
</span><span style="-webkit-tap-highlight-color: transparent; color: blue; margin: 0px; padding: 0px;">for</span> (<span style="-webkit-tap-highlight-color: transparent; color: blue; margin: 0px; padding: 0px;">int</span> i = 1; i &lt;= 6000; i++<span style="-webkit-tap-highlight-color: transparent; color: black; margin: 0px; padding: 0px;">)
{
result </span>+=<span style="-webkit-tap-highlight-color: transparent; color: black; margin: 0px; padding: 0px;"> i.ToString();
</span><span style="-webkit-tap-highlight-color: transparent; color: blue; margin: 0px; padding: 0px;">int</span> len =<span style="-webkit-tap-highlight-color: transparent; color: black; margin: 0px; padding: 0px;"> result.Length;
Response.Headers.Add(</span>"Content-Length"<span style="-webkit-tap-highlight-color: transparent; color: black; margin: 0px; padding: 0px;">, len.ToString());
Response.Headers.Add(</span>"Content-Encoding", "UTF-8"<span style="-webkit-tap-highlight-color: transparent; color: black; margin: 0px; padding: 0px;">);
Response.Write(result);
}
}</span></pre></div><p style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 17px; margin: 0px; padding: 0px; text-align: justify;">注意到 ：：</p><p style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 17px; margin: 0.133rem 0px 0px; padding: 0px; text-align: justify;">Response.Headers.Add("Content-Length", len.ToString());<br style="-webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;" />Response.Headers.Add("Content-Encoding", "UTF-8");</p><p style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 17px; margin: 0.133rem 0px 0px; padding: 0px; text-align: justify;"><span style="-webkit-tap-highlight-color: transparent; color: red; margin: 0px; padding: 0px;">写出 http 头时候，附加 “Content-Length”和 Content-Encoding，</span></p><p style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 17px; margin: 0.133rem 0px 0px; padding: 0px; text-align: justify;">这样 JS 端的 progress 事件的<span style="-webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><span style="-webkit-tap-highlight-color: transparent; color: red; margin: 0px; padding: 0px;">&nbsp;event.lengthComputable</span>&nbsp;</span>值才会为&nbsp;<code style="-webkit-tap-highlight-color: transparent; font-family: monospace, monospace; font-size: 1em; margin: 0px; padding: 0px;">true</code>，<span style="-webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><span style="-webkit-tap-highlight-color: transparent; color: red; margin: 0px; padding: 0px;">&nbsp;event.total</span></span>&nbsp;才会在数据传输完毕之前取得值，</p><p style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 17px; margin: 0.133rem 0px 0px; padding: 0px; text-align: justify;">否则 event.lengthComputable 值会返回&nbsp;<code style="-webkit-tap-highlight-color: transparent; font-family: monospace, monospace; font-size: 1em; margin: 0px; padding: 0px;">false</code>， event.total 在数据完成之前值都是<code style="-webkit-tap-highlight-color: transparent; font-family: monospace, monospace; font-size: 1em; margin: 0px; padding: 0px;">0</code>。</p><p style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 17px; margin: 0.133rem 0px 0px; padding: 0px; text-align: justify;"><br /></p><p style="-webkit-tap-highlight-color: transparent; background-color: #fafafa; font-size: 17px; margin: 0.133rem 0px 0px; padding: 0px; text-align: justify;">项目地址：&nbsp;<a href="https://github.com/dotennin/baidu-pan-downloader" style="background-color: transparent; text-align: left;">https://github.com/dotennin/baidu-pan-downloader</a></p></div></div>
